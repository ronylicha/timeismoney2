<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6" />
    <link rel="manifest" href="/app-manifest-v3.json" />

    <!-- Apple/iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="TimeIsMoney" />

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="167x167" href="/images/icons/apple-touch-icon-167x167.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png" />

    <!-- Apple Splash Screens for iOS PWA -->
    <!-- iPhone 14 Pro Max, 15 Plus, 15 Pro Max - 1290x2796 -->
    <link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/images/splash/splash-1290x2796.png" />

    <!-- iPhone 14 Pro, 15, 15 Pro - 1179x2556 -->
    <link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/images/splash/splash-1179x2556.png" />

    <!-- iPhone 14, 13 Pro, 13, 12 Pro, 12 - 1170x2532 -->
    <link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/images/splash/splash-1170x2532.png" />

    <!-- iPhone 13 mini, 12 mini - 1125x2436 -->
    <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/images/splash/splash-1125x2436.png" />

    <!-- iPhone SE 3rd gen - 750x1334 -->
    <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/images/splash/splash-750x1334.png" />

    <!-- iPad Pro 12.9" - 2048x2732 -->
    <link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" href="/images/splash/splash-2048x2732.png" />

    <!-- iPad Pro 11" - 1668x2388 -->
    <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" href="/images/splash/splash-1668x2388.png" />

    <!-- iPad 10.9" - 1640x2360 -->
    <link rel="apple-touch-startup-image" media="(device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2)" href="/images/splash/splash-1640x2360.png" />

    <!-- Other Meta Tags -->
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />

    <!-- Favicon variations -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />

    <title>TimeIsMoney - Gestion du temps et facturation</title>
    <meta name="description" content="Application complÃ¨te de gestion du temps et de facturation" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>

    <script>
      // Detect if app is running in standalone mode (PWA)
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
        // In PWA mode, always redirect to login if not on login page
        window.addEventListener('DOMContentLoaded', function() {
          const currentPath = window.location.pathname;
          const isAuthPath = ['/login', '/register', '/forgot-password'].includes(currentPath);
          const isDashboardPath = currentPath.startsWith('/dashboard');

          // If user is on landing page in PWA mode, redirect to login
          if (currentPath === '/' || currentPath === '/index.html') {
            window.location.href = '/login';
          }
        });
      }

      // Register service worker for PWA (only in production)
      if ('serviceWorker' in navigator) {
        // Check if we're in development mode (Vite dev server)
        const isDevelopment = window.location.port >= '5173' && window.location.port <= '5177';

        if (isDevelopment) {
          // Unregister all service workers in development
          navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for (let registration of registrations) {
              registration.unregister();
              console.log('Service worker unregistered in development mode');
            }
          });
        } else {
          // Production mode - register service worker
          // Listen for cache update messages
          navigator.serviceWorker.addEventListener('message', function(event) {
            if (event.data.type === 'CACHE_UPDATED') {
              console.log('Cache updated to version:', event.data.version);
              // Force reload to get new content
              window.location.reload(true);
            }
          });

          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js?v=3.2.0').then(function(registration) {
              console.log('ServiceWorker registration successful with version 3.2.0');
              // Check for updates immediately
              registration.update();

              // Check for updates every 30 seconds (for testing)
              setInterval(() => {
                registration.update();
              }, 30000);
            }, function(err) {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }
      }
    </script>
  </body>
</html>